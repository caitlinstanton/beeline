<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Displaying text directions with <code>setPanel()</code></title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
        background-color: #fff;
      }
      #panel {
        position: absolute;
        top: 5px;
        left: 50%;
        margin-left: -180px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }
    </style>
    <style>
      #directions-panel {
        height: 100%;
        float: right;
        width: 390px;
        overflow: auto;
        background-color: #fff;
      }

      #map-canvas {
        margin-right: 400px;
      }

      #control {
        background: #fff;
        padding: 5px;
        font-size: 14px;
        font-family: Arial;
        border: 1px solid #ccc;
        box-shadow: 0 2px 2px rgba(33, 33, 33, 0.4);
        display: none;
        
      }

      @media print {
        #map-canvas {
          height: 500px;
          margin: 0;
        }

        #directions-panel {
          float: none;
          width: auto;
        }
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <script>
var directionsDisplay;
var directionsService = new google.maps.DirectionsService();

function initialize() {
  directionsDisplay = new google.maps.DirectionsRenderer();
  var mapOptions = {
    zoom: 7,
    center: new google.maps.LatLng(40.7180139, -74.0138939)
  };
  var map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);
  directionsDisplay.setMap(map);
  directionsDisplay.setPanel(document.getElementById('directions-panel'));

  var control = document.getElementById('control');
  control.style.display = 'block';
  map.controls[google.maps.ControlPosition.TOP_CENTER].push(control);
}

function calcRoute() {
  var start = document.getElementById('start').value;
  var end = document.getElementById('end').value;
  var request = {
    origin: start,
    destination: end,
    travelMode: google.maps.TravelMode.DRIVING
  };
  directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
    }
  });
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="control">
      <strong>Start:</strong>
      <input id="start" type="textbox" value="New York, NY" onchange="calcRoute();">
      <strong>End:</strong>
      <select id="end" onchange="calcRoute();">
        <option value="philadelphia, pa">Dragon Hacks</option>
        <option value="ann arbor, mi">MHacks</option>
        <option value="philadelphia, pa">PennApps</option>
        <option value="noone, nc">AppHack</option>
        <option value="houston, tx">Hack.Rice</option>
        <option value="brunswick, me">CBBhacks</option>
        <option value="cleveland, oh">Hack CWRU</option>
      </select>
    </div>
    <div id="directions-panel"></div>
    <div id="map-canvas"></div>
      
    
<h1>Events Map </h1>


<div id="map-canvas"></div>
<div id="map-list">

<h4>Upcoming Events</h4>
  <ul></ul>
  <a href="#" class="load-more" data-last-search="">Load More...</a>
</div>

<p>
  <a style="margin-top: 2em; padding-left:48%; margin-bottom:10px" href="http://startupweekend.org/organizer">
    Interested in Organizing an Event? Read the Organizers Guide 
  </a>
</p>

<script type="text/javascript">
  (function ($) {
    $(function () {
      var mapWidth = $('#content').outerWidth() * 0.75;
      var mapHeight = mapWidth * 0.5;

      $('#map-canvas').data({
        width: mapWidth,
        height: mapHeight
      }).css('width', mapWidth);
      $('#map-canvas').citiesmap({
        urlBase: 'https://swoop.up.co',
        programsOfInterest: ['Startup Weekend'],
        width: mapWidth,
        height: mapHeight,
        showActiveCityToggle: true
      });
    });

    $(function () {
      // Build the map list
      var dateToJsonString = function (d) {
        return '' + d.getUTCFullYear() +
          '-' + (d.getUTCMonth() + 1) +
          '-' + d.getUTCDate();
      };
      var dateToListingString = function (d) {
        var monthList = ['January', 'February', 'March', 'April', 'May',
          'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        if (typeof d === "string") {
          d = new Date(d);
        }

        if (d) {
          return d.getUTCDate() + " " +
            monthList[d.getUTCMonth()] + ", " +
            d.getUTCFullYear();
        } else {
          return "";
        }
      };

      var addDaysToDate = function (date, numDays) {
        var _d = new Date(date.getTime());
        var daysInMs = 1000 * 60 * 60 * 24 * numDays;

        _d.setTime(_d.getTime() + daysInMs);
        return _d;
      };

      var generate30DayQuery = function (date) {
        return {
          since: dateToJsonString(date),
          until: dateToJsonString(addDaysToDate(date, 30)),
          event_type: 'Startup Weekend',
          event_status: 'G|W'
        };
      };

      var getEventUrl = function (primaryField, fallbackField, event) {
        var primaryValue = event[primaryField];
        var fallbackValue = event[fallbackField];
        var returnValue = '';

        if (event && primaryValue && primaryValue.length > 0) {
          returnValue = primaryValue;
        } else if (event && fallbackValue && fallbackValue.length > 0) {
          returnValue = fallbackValue;
        } else {
          returnValue = 'http://www.startupweekend.org';
        }

        if (/https?/.test(returnValue)) {
          return returnValue;
        } else {
          return 'http://' + returnValue;
        }
      };

      var getEventLocation = function (event) {
        var parts = [];

        return ['city', 'state', 'country'].filter(function (field) {
          return event[field] && event[field].length > 0;
        }).map(function (field) {
          return event[field];
        }).join(', ');
      };

      var addEventsToList = function (events) {
        var $listContainer = $('#map-list');
        var $list;
        var dateGroup = {};

        if ($listContainer.find('ul').length === 0) {
          $listContainer.append('<ul></ul>');
        }
        $list = $listContainer.find('ul');

        events.forEach(function (event) {
          var jsonDate = dateToJsonString(new Date(event.start_date));
          dateGroup[jsonDate] = dateGroup[jsonDate] || [];

          dateGroup[jsonDate].push(event);
        });

        var eventsList = Object.keys(dateGroup).map(function (dateString) {
          var dateParts = dateString.split('-').map(function (d) { return parseInt(d, 10); });
          // Account for JavaScript date months being off by 1
          dateParts[1] = dateParts[1] - 1;

          return "<li class='groupHeading'>" +
            // Header for date group
            dateToListingString(new Date(Date.UTC(dateParts[0], dateParts[1], dateParts[2]))) +
            "</li>" + 
            // The events themselves
            dateGroup[dateString].map(function (event) {
              return "<li>" +
                "<p>" +
                  // Event location
                  getEventLocation(event) +
                  // Vertical, if present
                  ((event.vertical && event.vertical.length > 0) ? (' - ' + event.vertical) : '') +
                "</p>" +
                "<p>" +
                  // Event link
                  "<a href='" + getEventUrl('website', 'eventbrite_url', event) + "' target='_blank'>More Info</a>" +
                "</p>" +
              "</li>";
            }).join('');
        }).join('');


        $list.append(eventsList);
      };

      $('#map-list').css({
        'width': ($('#content').outerWidth() * 0.25) - 50,
        'height': ($('#content').outerWidth() * 0.75 * 0.5)
      });

      // Given a data, build a search for events 30 days out and load into page
      var beginSearch = function (queryStart) {
        var query = generate30DayQuery(queryStart);
        $.ajax({
          dataType: 'jsonp',
          url: 'https://swoop.up.co/events',
          data: query,
          success: addEventsToList
        });
      };

      // Kick off initial search
      beginSearch(new Date());

      // Leave last search date in 'Load More' control
      // and then set up a "load more" handler
      $('#map-list .load-more')
        .data('last-search', (new Date()).getTime())
        .click(function (evt) {
          var el = $(evt.currentTarget);
          var lastDate = new Date(parseInt(el.data('last-search'), 10));
          var newDate = addDaysToDate(lastDate, 31);

          beginSearch(newDate);

          var list = $('#map-list ul');
          list.animate({
            'scrollTop': list[0].scrollHeight
          });

          // Leave the new search point
          el.data('last-search', newDate.getTime());

          evt.stopPropagation();
          evt.preventDefault();
          return false;
        });
    });

  })(jQuery203 || jQuery);

</script>
</div>
  </body>
</html>
